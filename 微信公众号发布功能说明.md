 # 微信公众号发布功能实现说明

## 功能概述

实现了完整的微信公众号图片发布流程，包括：
1. 选择微信公众号API账号和插图标签
2. 根据标签查询符合条件的图片
3. 下载图片到本地
4. 标记不合格图片
5. 发布到微信公众号

## 技术架构

### 前端 (React + TypeScript + Ant Design)
- **组件化设计**: 将功能拆分为5个独立步骤组件
- **状态管理**: 使用React Hooks管理状态和步骤切换
- **API集成**: 通过统一的API服务与后端交互
- **用户体验**: 实时进度显示和友好的交互界面

### 后端 (Node.js + Express + TypeScript)
- **RESTful API**: 提供完整的CRUD接口
- **数据库集成**: 使用Supabase PostgreSQL数据库
- **任务管理**: 异步任务处理和进度跟踪
- **错误处理**: 完善的错误处理和日志记录

## 核心功能实现

### 1. 图片查询逻辑

参考Python代码的SQL查询逻辑，实现了以下过滤条件：

```typescript
// 不支持标签过滤
unsupport_tags.forEach(tag => {
  query = query.not('tag', 'ilike', `%${tag}%`);
});

// 支持标签过滤
const tagConditions = tags.map(tag => `tag.ilike.%${tag}%`);
query = query.or(tagConditions.join(','));

// 公众号使用状态过滤
query = query.or(`wx_name.not.ilike.%${wx_name}%,wx_name.is.null`);

// 不合格图片过滤
query = query.not('unfit', 'eq', true);
```

### 2. 异步任务处理

使用任务ID和进度跟踪机制：

```typescript
// 创建任务
const taskId = uuidv4();
taskProgress.set(taskId, { progress: 0, status: 'downloading' });

// 异步执行任务
this.executeDownloadTask(taskId, pids);

// 返回任务ID供前端轮询
return taskId;
```

### 3. 前端轮询机制

```typescript
// 轮询下载进度
const progressInterval = setInterval(async () => {
  const progressResponse = await weixinPublishAPI.getDownloadProgress(taskId);
  
  if (progressResponse.success && progressResponse.data) {
    const { progress, status } = progressResponse.data;
    setDownloadProgress(progress);
    
    if (status === 'completed') {
      clearInterval(progressInterval);
      // 处理完成逻辑
    }
  }
}, 1000);
```

## API接口说明

### 1. 查询图片
```
POST /api/v1/weixin/query-pics
{
  "wx_name": "公众号名称",
  "tags": ["标签1", "标签2"],
  "unsupport_tags": ["不支持标签"],
  "limit": 10
}
```

### 2. 下载图片
```
POST /api/v1/weixin/download-pics
{
  "pids": [1, 2, 3]
}
```

### 3. 获取下载进度
```
GET /api/v1/weixin/download-progress/:taskId
```

### 4. 发布到微信公众号
```
POST /api/v1/weixin/publish
{
  "account_id": 1,
  "pids": [1, 2, 3],
  "unfit_pids": [3]
}
```

### 5. 获取发布进度
```
GET /api/v1/weixin/publish-progress/:taskId
```

## 数据库表结构

### Pic表
```sql
CREATE TABLE Pic (
  pid SERIAL PRIMARY KEY,
  url TEXT,
  tag TEXT,
  wx_name TEXT,
  unfit BOOLEAN DEFAULT FALSE,
  used_at TIMESTAMP
);
```

### api_accounts_wx表
```sql
CREATE TABLE api_accounts_wx (
  id SERIAL PRIMARY KEY,
  name VARCHAR(255),
  wx_id VARCHAR(255),
  illust_tag JSONB,
  created_at TIMESTAMP DEFAULT NOW()
);
```

## 部署和运行

### 1. 启动后端服务
```bash
cd nodejs_backend
npm install
npm run dev
```

### 2. 启动前端服务
```bash
cd frontend
npm install
npm run dev
```

### 3. 访问应用
- 前端: http://localhost:5173
- 后端API: http://localhost:3000

## 测试

使用提供的测试脚本验证API功能：

```bash
node test_weixin_api.js
```

## 扩展功能

1. **真实图片下载**: 实现从URL下载图片到本地
2. **微信公众号API集成**: 集成真实的微信公众号API
3. **Redis任务队列**: 使用Redis替代内存存储任务状态
4. **图片处理**: 添加图片压缩、格式转换等功能
5. **批量操作**: 支持批量发布和批量标记

## 注意事项

1. 确保Supabase数据库连接正常
2. 配置正确的环境变量
3. 创建必要的数据库表
4. 处理跨域请求配置
5. 实现适当的错误处理和重试机制